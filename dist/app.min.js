"use strict";

(function () {
  var e, t, r, n, i, a, o, s;"production" !== process.env.NODE_ENV && require("dotenv").config(), i = require("restify"), s = require("trim"), n = require("request"), e = require("cheerio"), a = i.createServer({ name: "ebay-ending-watcher", version: "1.0.0" }), a.use(i.acceptParser(a.acceptable)), a.use(i.queryParser()), a.use(i.bodyParser()), a.use(function (e, t, r) {
    return t.header("Access-Control-Allow-Origin", "*"), t.header("Access-Control-Allow-Headers", "X-Requested-With"), r();
  }), a.get("/amazon-offer/:itemId", function (t, r, i) {
    var a;return a = "http://www.amazon." + (t.params.domain || "com") + "/gp/offer-listing/" + t.params.itemId + "/ref=dp_olp_all_mbc?ie=UTF8&condition=all", console.log(a), n(a, function (n, i, o) {
      var l, c, m, u, d, p, f, _, h, g, w;return console.log(i), 200 === i.statusCode ? (l = e.load(o), f = function () {
        var e, t, r, n;for (r = l(".olpOffer").slice(0, 6), n = [], e = 0, t = r.length; e < t; e++) {
          m = r[e], p = s(l(m).find(".olpOfferPrice").text()), c = function () {
            switch (!1) {case !p.match(/EUR/):
                return "EUR";case !p.match(/^\$/):
                return "USD";case !p.match(/^Â£/):
                return "GBP";default:
                return null;}
          }(), d = "USD" === c, u = "GBP" === c, _ = function () {
            switch (!1) {case !u:
                return parseFloat(p.match(/[\d,]+/)[0].replace(/,/, ""));case !d:
                return parseFloat(p.replace(/[^0-9\.-]+/g, ""));default:
                return parseFloat(p.match(/[\d\.]+/)[0].replace(/\./, ""));}
          }(), h = s(l(m).find(".olpSellerColumn").text()), g = h.match(/\((\d+)/), g = parseFloat(g ? g[1] : 0), w = h.match(/\d+%/), w = parseFloat(w ? w[0] : "0"), n.push({ sellerRatingPct: w, sellerRatingCount: g, price: _, currency: c, condition: s(l(m).find(".olpConditionColumn .olpCondition").text()), sellerInformation: h });
        }return n;
      }(), r.send({ id: t.params.itemId, title: s(l("#olpProductDetails h1").text()), itemListingUrl: a, offersData: f })) : r.send({ error: r.statusCode });
    });
  }), o = function o(e) {
    return e(".s-item").slice(0, 6);
  }, t = function t(e, _t) {
    var r, n, i;return i = "New Listing" === e(_t).find(".LIGHT_HIGHLIGHT").text(), n = "Buy It Now" === e(_t).find(".s-item__purchase-options").text(), r = parseInt(e(_t).find(".s-item__bids ").text()), { title: s(e(_t).find("h3.s-item__title").text()), buyItNowFlag: n, newListingFlag: i, bids: r, price: parseFloat(s(e(_t).find(".s-item__price").text()).replace(",", "").replace("$", "")), timeLeftText: e(_t).find(".s-item__time-left").text().split(" left")[0], endsAt: parseInt(e(_t).find(".timeleft .timeMs").attr("timems")), itemListingUrl: e(_t).find(".s-item__link").attr("href"), itemPictureUrl: e(_t).find(".s-item__image-img").attr("src") };
  }, a.get("/ebay-new-listings/:name", function (r, i, a) {
    var s;return s = "http://www.ebay." + (r.params.domain || "com") + "/sch/i.html?_from=R40&_sacat=0&_nkw=" + r.params.name + "&_sop=10&_udlo=" + r.params.price_low + "&_udhi=" + r.params.price_high + "&LH_ItemCondition=1000|1500|3000", console.log(s), n(s, function (r, n, a) {
      var s, l, c;return s = e.load(a), c = function () {
        var e, r, n, i;for (n = o(s), i = [], e = 0, r = n.length; e < r; e++) {
          l = n[e], i.push(t(s, l));
        }return i;
      }(), i.send(c);
    }), a();
  }), a.get("/ebay-ending-soon/:name", function (r, i, a) {
    var s, l, c, m;return l = r.params.LH_Complete || 0, c = r.params.LH_Sold || 0, s = r.params.LH_BIN || 0, m = "http://www.ebay." + (r.params.domain || "com") + "/sch/i.html?_from=R40&_sacat=0&_nkw=" + r.params.name + "&_sop=1&_udlo=" + r.params.price_low + "&_udhi=" + r.params.price_high + "&LH_Complete=" + l + "&LH_Sold=" + c + "&LH_BIN=" + s + "&LH_ItemCondition=1000|1500|3000", console.log(m), n(m, function (r, n, a) {
      var s, l, c;200 === n.statusCode && (s = e.load(a), c = function () {
        var e, r, n, i;for (n = o(s), i = [], e = 0, r = n.length; e < r; e++) {
          l = n[e], i.push(t(s, l));
        }return i;
      }(), i.send(c));
    }), a();
  }), r = process.env.PORT || 5e3, a.listen(r, function () {
    console.log("%s listening at %s", a.name, a.url);
  });
}).call(undefined);