"use strict";

(function () {
  var e, t, r, a, n, o;"production" !== process.env.NODE_ENV && require("dotenv").config(), a = require("restify"), o = require("trim"), r = require("request"), e = require("cheerio"), n = a.createServer({ name: "ebay-ending-watcher", version: "1.0.0" }), n.use(a.acceptParser(n.acceptable)), n.use(a.queryParser()), n.use(a.bodyParser()), n.use(function (e, t, r) {
    return t.header("Access-Control-Allow-Origin", "*"), t.header("Access-Control-Allow-Headers", "X-Requested-With"), r();
  }), n.get("/amazon-offer/:itemId", function (t, a, n) {
    var i;return i = "http://www.amazon." + (t.params.domain || "com") + "/gp/offer-listing/" + t.params.itemId + "/ref=dp_olp_all_mbc?ie=UTF8&condition=all", console.log(i), r(i, function (r, n, l) {
      var s, c, u, d, p, m, f, h, g, _, v;return console.log(n), 200 === n.statusCode ? (s = e.load(l), f = function () {
        var e, t, r, a;for (r = s(".olpOffer").slice(0, 6), a = [], e = 0, t = r.length; e < t; e++) {
          u = r[e], m = o(s(u).find(".olpOfferPrice").text()), c = function () {
            switch (!1) {case !m.match(/EUR/):
                return "EUR";case !m.match(/^\$/):
                return "USD";case !m.match(/^Â£/):
                return "GBP";default:
                return null;}
          }(), p = "USD" === c, d = "GBP" === c, h = function () {
            switch (!1) {case !d:
                return parseFloat(m.match(/[\d,]+/)[0].replace(/,/, ""));case !p:
                return parseFloat(m.replace(/[^0-9\.-]+/g, ""));default:
                return parseFloat(m.match(/[\d\.]+/)[0].replace(/\./, ""));}
          }(), g = o(s(u).find(".olpSellerColumn").text()), _ = g.match(/\((\d+)/), _ = parseFloat(_ ? _[1] : 0), v = g.match(/\d+%/), v = parseFloat(v ? v[0] : "0"), a.push({ sellerRatingPct: v, sellerRatingCount: _, price: h, currency: c, condition: o(s(u).find(".olpConditionColumn .olpCondition").text()), sellerInformation: g });
        }return a;
      }(), a.send({ id: t.params.itemId, title: o(s("#olpProductDetails h1").text()), itemListingUrl: i, offersData: f })) : a.send({ error: a.statusCode });
    });
  }), n.get("/ebay-ending-soon/:name", function (t, a, n) {
    var i, l, s, c;return l = t.params.LH_Complete || 0, s = t.params.LH_Sold || 0, i = t.params.LH_BIN || 0, c = "http://www.ebay." + (t.params.domain || "com") + "/sch/i.html?_from=R40&_sacat=0&_nkw=" + t.params.name + "&_sop=1&_udlo=" + t.params.price_low + "&_udhi=" + t.params.price_high + "&LH_Complete=" + l + "&LH_Sold=" + s + "&LH_BIN=" + i + "&LH_ItemCondition=1000|1500|3000", console.log(c), r(c, function (t, r, n) {
      var i, l, s;200 === r.statusCode && (i = e.load(n), s = function () {
        var e, t, r, a;for (r = i(".sresult").slice(0, 6), a = [], e = 0, t = r.length; e < t; e++) {
          l = r[e], a.push({ title: o(i(l).find("h3.lvtitle").text()), price: parseFloat(o(i(l).find(".lvprice").text()).replace(",", "").replace("$", "")), endsAt: parseInt(i(l).find(".timeleft .timeMs").attr("timems")), itemListingUrl: i(l).find(".lvtitle a").attr("href"), itemPictureUrl: i(l).find(".lvpic img").attr("src") });
        }return a;
      }(), a.send(s));
    }), n();
  }), t = process.env.PORT || 5e3, n.listen(t, function () {
    console.log("%s listening at %s", n.name, n.url);
  });
}).call(undefined);